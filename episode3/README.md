# Episode 3

## The Premise

In this episode we continue from Episode 2 and dig deeper into the code generated by the Rust compiler for loops and compare that code with the code generated by a similar loop in C++.

In particular, we look at the code generated by Rust for the loop in the following program:

```
use volatile::Volatile;

fn main() {
    let mut j = 0;
    let mut v = Volatile::new(&mut j);

    for _ in 0..1000000000 {
        v.write(v.read() + 1);
    }
}
```

```
#include <iostream>
#include <numeric>
#include <vector>

int main() {
	volatile int j = 0;
	std::vector<int> range(100000000);
	std::iota(range.begin(), range.end(), 0);

	for (auto i : range) {
		// Cannot do j++ because pre/post increment
		// operations on volatile-qualified operations
		// are deprecated in C++20.
		int temp = j;
		temp++;
		j = temp;
	}
}
```

## The Research

## The Answer

## Walkthrough


### Rust
```
    5160:	48 83 ec 04          	sub    $0x4,%rsp
    5164:	c7 04 24 00 00 00 00 	movl   $0x0,(%rsp)
    516b:	b8 00 ca 9a 3b       	mov    $0x3b9aca00,%eax
    5170:	83 04 24 01          	addl   $0x1,(%rsp)
    5174:	83 04 24 01          	addl   $0x1,(%rsp)
    5178:	83 04 24 01          	addl   $0x1,(%rsp)
    517c:	83 04 24 01          	addl   $0x1,(%rsp)
    5180:	83 04 24 01          	addl   $0x1,(%rsp)
    5184:	83 c0 fb             	add    $0xfffffffb,%eax
    5187:	75 e7                	jne    5170 <episode3::main+0x10>
```

```
    113d:	ba 00 e1 f5 05       	mov    $0x5f5e100,%edx
    1142:	66 0f 1f 44 00 00    	nopw   0x0(%rax,%rax,1)
    1148:	8b 44 24 0c          	mov    0xc(%rsp),%eax
    114c:	83 c0 01             	add    $0x1,%eax
    114f:	89 44 24 0c          	mov    %eax,0xc(%rsp)
    1153:	48 83 ea 01          	sub    $0x1,%rdx
    1157:	75 ef                	jne    1148 <main+0x68>
```

With -funroll-loops
```
    1195:	8b 74 24 0c          	mov    0xc(%rsp),%esi
    1199:	83 c6 01             	add    $0x1,%esi
    119c:	89 74 24 0c          	mov    %esi,0xc(%rsp)
    11a0:	44 8b 44 24 0c       	mov    0xc(%rsp),%r8d
    11a5:	41 83 c0 01          	add    $0x1,%r8d
    11a9:	44 89 44 24 0c       	mov    %r8d,0xc(%rsp)
    11ae:	44 8b 4c 24 0c       	mov    0xc(%rsp),%r9d
    11b3:	41 83 c1 01          	add    $0x1,%r9d
    11b7:	44 89 4c 24 0c       	mov    %r9d,0xc(%rsp)
    11bc:	44 8b 54 24 0c       	mov    0xc(%rsp),%r10d
    11c1:	41 83 c2 01          	add    $0x1,%r10d
    11c5:	44 89 54 24 0c       	mov    %r10d,0xc(%rsp)
    11ca:	44 8b 5c 24 0c       	mov    0xc(%rsp),%r11d
    11cf:	41 83 c3 01          	add    $0x1,%r11d
    11d3:	44 89 5c 24 0c       	mov    %r11d,0xc(%rsp)
    11d8:	8b 44 24 0c          	mov    0xc(%rsp),%eax
    11dc:	83 c0 01             	add    $0x1,%eax
    11df:	89 44 24 0c          	mov    %eax,0xc(%rsp)
    11e3:	8b 54 24 0c          	mov    0xc(%rsp),%edx
    11e7:	83 c2 01             	add    $0x1,%edx
    11ea:	89 54 24 0c          	mov    %edx,0xc(%rsp)
    11ee:	8b 74 24 0c          	mov    0xc(%rsp),%esi
    11f2:	83 c6 01             	add    $0x1,%esi
    11f5:	89 74 24 0c          	mov    %esi,0xc(%rsp)
    11f9:	48 83 e9 08          	sub    $0x8,%rcx
    11fd:	75 96                	jne    1195 <main+0xb5>
``` 
